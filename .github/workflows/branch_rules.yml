name: üîí Branch Policy

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, preprod]
  workflow_dispatch:

jobs:
  validate_branch_policy:
    name: üß≠ Validate Branch Policy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: üß© Extract Branch Info
        id: info
        run: |
          echo "head_ref=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          echo "base_ref=${{ github.base_ref }}" >> $GITHUB_OUTPUT

      - name: üö´ Enforce Branch & Merge Rules
        run: |
          HEAD=${{ steps.info.outputs.head_ref }}
          BASE=${{ steps.info.outputs.base_ref }}

          echo "üîç Checking PR: $HEAD ‚Üí $BASE"

          # V√©rifie le nom de la branche
          if [[ "$HEAD" != feature/* && "$HEAD" != hotfix/* && "$HEAD" != preprod && "$HEAD" != main ]]; then
            echo "‚ùå ERROR: Invalid branch name."
            echo "Branches must start with feature/, hotfix/, or be preprod/main."
            exit 1
          fi

          # R√®gles de merge autoris√©es
          if [[ "$HEAD" == feature/* && "$BASE" == "preprod" ]]; then exit 0; fi
          if [[ "$HEAD" == "preprod" && "$BASE" == "main" ]]; then exit 0; fi
          if [[ "$HEAD" == hotfix/* && ( "$BASE" == "main" || "$BASE" == "preprod" ) ]]; then exit 0; fi
          if [[ "$HEAD" == "main" && "$BASE" == "preprod" ]]; then exit 0; fi

          echo "‚ùå ERROR: Merge from '$HEAD' to '$BASE' is NOT allowed."
          exit 1
